---
layout:     post
title:      Java面试题总结——网络相关
subtitle:   Java面试题总结——网络相关
date:       2018-03-24
author:     mushuzi
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
   - Java
   - 网络
---

# 网络四层模型及其对应协议
- 应用层：HTTP、SMTP、FTP等
- 传输层：TCP、UDP等。其中，TCP提供可靠的数据流运输服务，UDP提供不可靠的数据流运输服务。
- 网络层：IP、ICMP、RIP等。其中，ICMP为网间控制报文协议，用来提供网络诊断信息；RIP为路由信息协议，负责数据的包装、寻址和路由。
- 物理链路层：ARP、RARP协议等，ARP协议和RARP协议分别为地址解析协议和逆地址解析协议，提供TCP/Ip的数据结构和实际硬件物理地址之间的转换。

# TCP和UDP的比较
- TCP是可靠的传输，它面向连接、面向字节流；UDP是不可靠的传输，它面向无连接、面向报文。
- TCP有流量控制（滑动窗口），UDP没有流量控制
- TCP有拥塞控制（慢开始、拥塞避免、快重传、快恢复），UDP没有拥塞控制
- TCP传输速率较慢，效率较低；UDP传输速率较快，效率较高；
- TCP适应于对传输速率要求较低，但对可靠性要求较高的场合，以及要求有连接的场景；UDP是英语对可靠性要求较低，但对传输速率要求较高的场合，以及要求无连接的场景。
- TCP一般适用于文件传输、发送或接收邮件、远程登录等场景；UDP一般适用于即时通信、在线视频、网络语音电话等场景。

# TCP的流量控制-滑动窗口机制
滑动窗口协议是TCP流量控制的一种措施，接收方通知发送方自己的窗口大小，从而控制发送方发送数据的速度，以防发送方发送数据过快而导致接收方被淹没。

TCP窗口分为接收窗口和发送窗口。

接收方在收到数据后会给发送方发送一个ACK，这个ACK包含两个重要信息：

- 接收方期望收到的下一个字节的序号n，这意味着接收方已经成功收到了前1~n-1的字节。如果此时接收方收到的是第n+1个字节或者任何非第n个字节，接收方是不会发送序号为n+2的ACK的，而会依旧发送确认号为n的ACK；
- 当前的窗口大小m，如此发送方在接收到ACK中包含的这两个数据后就可以计算出还可以发送多少字节的数据给发送方。加入当前发送方已经发送到了第x个字节，则可以发送的字节数就是y=m-(x-n).

# TCP的拥塞控制-慢开始、拥塞避免、快重传、快恢复
- 慢开始：为了防止在不知道网络状况的情况下一次性向网络中注入大量数据，从小到大增加拥塞窗口数值，每经过一个传输轮次，拥塞窗口就加倍；
- 拥塞避免：当拥塞窗口达到慢开始门限时，每经过一个传输轮次，就让拥塞窗口加一，即保持线性增长。

拥塞控制过程：慢开始->拥塞避免->当出现网络拥塞时，慢开始门限变为原来的一半，拥塞窗口重新设置为1->慢开始->拥塞避免

- 快重传：当连续收到三次重复确认时，立即重传对方尚未收到的报文段，而不用等到重传计数器到期，以便发送方能尽早重传未被确认的报文段。
- 快恢复：当收到连续三个重复确认后，将拥塞窗口的值设置为之前的一般，但是不再执行慢开始算法，而是开始执行拥塞避免算法，使拥塞窗口线性增大。

拥塞控制过程：慢开始->拥塞避免->当发生连续三次重复确认时，立刻进行快重传，慢开始门限变为原来的一半->快恢复->拥塞避免

# TCP建立连接的三次握手

## 基本概念
首先明确在三次握手过程中，客户端和服务器端的几种状态：在最初时两端的TCP进程都处于closed状态，当想要建立连接时，客户端主动打开连接，而服务器端被动打开连接。从closed状态到建立连接，中间按照顺序会经历以下状态：

两端关闭状态（CLOSED）->服务器端监听状态（LISTEN）->客户端同步已发送状态（SYN-SENT）->服务器端同步已接收状态（SYN-RCVD）->两端连接已建立状态（ESTABLISHED）

## 三次握手
- 第一次握手：客户端向服务器端发出连接请求报文段，其中包含同步位SYN=1，初始序号seq=x，此时客户端进程进入SYN-SENT状态；
- 第二次握手：服务器端收到上述请求报文段后，如同意连接，则客户端发送确认报文，其中包括SYN=1，ACK=1，确认号ack=x+1，初始序号seq=y，然后服务器端进程进入SYN-RCVD的状态；
- 第三次握手：客户端进程在收到上述确认报文段后，在服务器端进程发送确认报文段，其中包括ACK=1，确认号ack=y+1，序号为seq=x+1（初始序号是x，这是第二个报文，所以要+1）。然后客户端TCP连接已建立，进入ESTABLISHED状态；

当服务器端收到客户端的确认后，也进入ESTABLISHED状态。

## 为什么连接的时候是三次握手，关闭的时候是四次握手？
因为当服务器端收到客户端的SYN请求建立连接后，可以之间发送ACK和SYN报文进行应答和同步。但是当关闭连接时，很可能服务器端在收到来自客户端的FIN报文时，还不能立刻关闭Socket，因此只能先回复一个ACK报文来向客户端确认收到了FIN报文，只有等到服务器端所有的报文都发送完毕，才能向客户端发送FIN报文，因此，需要将ACK和FIN报文分成两次发送。故而需要四次挥手。

## 为什么是三次握手，而不是两次或者四次？
为什么不是两次？ 客户端还要再发送一次确认是为了防止已经失效的连接请求报文段突然又传送到了服务器端，从而造成错误。

为什么不是四次？ 三次握手已经可以确保双方可以正常接收和发送信息了，因此，从通信时间成本、空间成本以及可靠度来讲，无需四次握手，选择“三次握手”作为点对点通信的一般规则即可。

# Java网络编程
## 网络编程基本概念
IP地址+端口号构成了Socket，Socket是网络上运行的程序之间进行通信的终结点，是TCP和UDP的基础。

网络上具有唯一标识的IP地址和端口组合在一起才能构成唯一识别的标识符套接字。

Socket的原理机制有三：
- 通信两段都有Socket；
- 网络通信其实就是Socket之间的通信；
- 数据在两个Socket之间进行IO传输。

## Java提供的支持
Java网络编程提供以下四个层次的支持：
- InetAddress：用于标识网络上的硬件资源，主要是IP地址（物理链路层）
- URL：统一资源定位符，通过URL可以直接读取或者写入网络上的数据（网络层）
- Sockets：使用TCP协议实现网络通信的相关类（传输层）
- Datagram：使用UDP协议实现网络通信相关的类（传输层）

## TCP编程：客户端的Socket类和服务器端的ServerSocket类
### 服务器端步骤：
- 创建ServerSocket对象，绑定监听端口；
- 通过accept()方法监听客户端请求；
- 连接建立后，通过输入流读取客户端发送的请求信息；
- 通过输出流向客户端发送响应信息；
- 关闭相关资源；

### 客户端步骤：
- 创建Socket对象，指明需要连接的服务器的地址和端口号；
- 连接建立后，通过输出流向服务器端发送请求信息；
- 通过输入流获取服务器端的响应信息
- 关闭响应资源

## UDP编程：DatagramPacket类和 DatagramSocket类
### 服务器端步骤：
- 创建DatagramSocket，指定端口号；
- 创建DatagramPacket对象；
- 接收客户端发送的数据信息；
- 读取数据

### 客户端步骤：
- 定义发送信息；
- 用DatagramPacket来封装将要发送的信息；
- 创建DatagramSocket对象
- 发送数据
